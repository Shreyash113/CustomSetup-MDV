# ============================================================================
# Stage 1: Builder - Clone ComfyUI and install all Python packages (CUDA 12.8)
# ============================================================================
FROM ubuntu:22.04 AS builder

ENV DEBIAN_FRONTEND=noninteractive

# --- Bootstrap CA certificates reliably, then use HTTPS repos ---
RUN sed -i 's|https://|http://|g' /etc/apt/sources.list && \
    apt-get -o Acquire::Retries=5 update && \
    apt-get install -y --no-install-recommends ca-certificates && \
    update-ca-certificates && \
    sed -i 's|http://|https://|g' /etc/apt/sources.list

# Install minimal dependencies needed for building
RUN apt-get -o Acquire::Retries=5 update && \
    apt-get install -y --no-install-recommends \
      software-properties-common \
      gpg-agent \
      git \
      wget \
      curl \
      ca-certificates \
    && add-apt-repository ppa:deadsnakes/ppa && \
    apt-get -o Acquire::Retries=5 update && \
    apt-get install -y --no-install-recommends \
      python3.12 \
      python3.12-venv \
      python3.12-dev \
      build-essential \
    && wget https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2204/x86_64/cuda-keyring_1.1-1_all.deb \
    && dpkg -i cuda-keyring_1.1-1_all.deb \
    && apt-get -o Acquire::Retries=5 update \
    && apt-get install -y --no-install-recommends cuda-minimal-build-12-8 \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/* \
    && rm -f cuda-keyring_1.1-1_all.deb

# Install pip for Python 3.12 and upgrade it
RUN curl -sS https://bootstrap.pypa.io/get-pip.py -o get-pip.py && \
    python3.12 get-pip.py && \
    python3.12 -m pip install --upgrade pip setuptools wheel && \
    rm -f get-pip.py

# Set CUDA environment for building
ENV PATH=/usr/local/cuda/bin:${PATH}
ENV LD_LIBRARY_PATH=/usr/local/cuda/lib64

# Clone ComfyUI to get requirements (robust clone: shallow + retries)
WORKDIR /tmp/build
RUN set -eux; \
    git config --global http.postBuffer 1048576000; \
    git config --global http.lowSpeedLimit 0; \
    git config --global http.lowSpeedTime 999999; \
    for i in 1 2 3 4 5; do \
      echo "Cloning ComfyUI attempt $i..."; \
      rm -rf ComfyUI; \
      git clone --depth 1 --filter=blob:none https://github.com/comfyanonymous/ComfyUI.git && break; \
      sleep 5; \
    done; \
    test -d ComfyUI

# Clone custom nodes to get their requirements (robust clone: shallow + retries)
WORKDIR /tmp/build/ComfyUI/custom_nodes
RUN set -eux; \
    git config --global http.postBuffer 1048576000; \
    git config --global http.lowSpeedLimit 0; \
    git config --global http.lowSpeedTime 999999; \
    for repo in \
      https://github.com/ltdrdata/ComfyUI-Manager.git \
      https://github.com/kijai/ComfyUI-KJNodes.git \
      https://github.com/MoonGoblinDev/Civicomfy.git \
      https://github.com/MadiatorLabs/ComfyUI-RunpodDirect.git \
      https://github.com/kijai/ComfyUI-WanVideoWrapper.git \
      https://github.com/Kosinkadink/ComfyUI-VideoHelperSuite.git \
      https://github.com/rgthree/rgthree-comfy.git \
      https://github.com/M1kep/ComfyLiterals.git \
      https://github.com/scofano/comfy-audio-duration.git \
      \
      # ✅ ADDED (optional but recommended to bake deps)
      https://github.com/Lightricks/ComfyUI-LTXVideo.git \
      https://github.com/ltdrdata/ComfyUI-Impact-Pack.git \
      https://github.com/ltdrdata/ComfyUI-Inspire-Pack.git \
      https://github.com/WASasquatch/was-node-suite-comfyui.git \
    ; do \
      name="$(basename "$repo" .git)"; \
      for i in 1 2 3 4 5; do \
        echo "Cloning $name attempt $i..."; \
        rm -rf "$name"; \
        git clone --depth 1 --filter=blob:none "$repo" "$name" && break; \
        sleep 5; \
      done; \
      test -d "$name"; \
    done

# Install PyTorch (stable CUDA 12.8 build) and core deps
RUN python3.12 -m pip install --no-cache-dir \
    torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu128

# Triton (Linux wheel, Python 3.12 compatible)
RUN python3.12 -m pip install --no-cache-dir triton==3.2.0

# Optional: SageAttention v1 (if it fails on cp312/your combo, build will continue)
RUN python3.12 -m pip install --no-cache-dir sageattention==1.0.6 || true

# ✅ ADDED: huggingface_hub so workflow sync doesn't reinstall every boot
RUN python3.12 -m pip install --no-cache-dir -U huggingface_hub

# Optional sanity check (prints versions during build logs)
RUN python3.12 - << 'PY'
import torch
print("torch:", torch.__version__)
try:
    import triton
    print("triton:", triton.__version__)
except Exception as e:
    print("triton import failed:", e)
try:
    import huggingface_hub
    print("huggingface_hub:", huggingface_hub.__version__)
except Exception as e:
    print("huggingface_hub import failed:", e)
PY

WORKDIR /tmp/build/ComfyUI
RUN python3.12 -m pip install --no-cache-dir -r requirements.txt && \
    python3.12 -m pip install --no-cache-dir GitPython opencv-python

# Install custom node dependencies
WORKDIR /tmp/build/ComfyUI/custom_nodes
RUN for node_dir in */; do \
        if [ -f "$node_dir/requirements.txt" ]; then \
            echo "Installing requirements for $node_dir"; \
            python3.12 -m pip install --no-cache-dir -r "$node_dir/requirements.txt" || true; \
        fi; \
    done

# ============================================================================
# Stage 2: Runtime - Clean image with pre-installed packages
# ============================================================================
FROM ubuntu:22.04

ENV DEBIAN_FRONTEND=noninteractive
ENV PYTHONUNBUFFERED=1
ENV IMAGEIO_FFMPEG_EXE=/usr/bin/ffmpeg
ENV FILEBROWSER_CONFIG=/workspace/runpod-slim/.filebrowser.json

# --- Bootstrap CA certificates reliably, then use HTTPS repos ---
RUN sed -i 's|https://|http://|g' /etc/apt/sources.list && \
    apt-get -o Acquire::Retries=5 update && \
    apt-get install -y --no-install-recommends ca-certificates && \
    update-ca-certificates && \
    sed -i 's|http://|https://|g' /etc/apt/sources.list

# ----------------------------
# Model auto-download (TXT manifest)
# ----------------------------
ENV MODEL_LIST_URL=""
ENV HF_TOKEN=""
ENV HUGGINGFACEHUB_API_TOKEN=""

# ✅ ADDED: HF workflows repo + optional subdir (override in RunPod env vars)
ENV HF_WORKFLOWS_REPO="Shreyash113/workflows"
ENV HF_WORKFLOWS_SUBDIR=""

# Update and install runtime dependencies, CUDA 12.8, and common tools
RUN apt-get -o Acquire::Retries=5 update && \
    apt-get upgrade -y && \
    apt-get install -y --no-install-recommends \
      software-properties-common \
      gpg-agent \
    && add-apt-repository ppa:deadsnakes/ppa && \
    add-apt-repository ppa:cybermax-dexter/ffmpeg-nvenc && \
    apt-get -o Acquire::Retries=5 update && \
    apt-get install -y --no-install-recommends \
      git \
      python3.12 \
      python3.12-venv \
      python3.12-dev \
      build-essential \
      libssl-dev \
      wget \
      gnupg \
      xz-utils \
      openssh-client \
      openssh-server \
      nano \
      curl \
      htop \
      tmux \
      ca-certificates \
      less \
      net-tools \
      iputils-ping \
      procps \
      golang \
      make \
    && wget https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2204/x86_64/cuda-keyring_1.1-1_all.deb \
    && dpkg -i cuda-keyring_1.1-1_all.deb \
    && apt-get -o Acquire::Retries=5 update \
    && apt-get install -y --no-install-recommends cuda-minimal-build-12-8 \
    && apt-get install -y --no-install-recommends ffmpeg \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/* \
    && rm -f cuda-keyring_1.1-1_all.deb

# Copy Python packages and pip executables from builder stage
COPY --from=builder /usr/local/lib/python3.12 /usr/local/lib/python3.12
COPY --from=builder /usr/local/bin /usr/local/bin

# --- CRITICAL FIX: ensure pip exists in runtime and is discoverable (ComfyUI-Manager needs python -m pip) ---
RUN python3.12 -m ensurepip --upgrade || true && \
    python3.12 -m pip install --upgrade pip setuptools wheel

# Remove uv to force ComfyUI-Manager to use pip
RUN python3.12 -m pip uninstall -y uv 2>/dev/null || true && \
    rm -f /usr/local/bin/uv /usr/local/bin/uvx

# Install FileBrowser
RUN curl -fsSL https://raw.githubusercontent.com/filebrowser/get/master/get.sh | bash

# Set CUDA environment variables
ENV PATH=/usr/local/cuda/bin:${PATH}
ENV LD_LIBRARY_PATH=/usr/local/cuda/lib64

# Install Jupyter with Python kernel (call via python to avoid PATH issues)
RUN python3.12 -m pip install jupyter

# Configure SSH for root login
RUN sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config && \
    sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config && \
    mkdir -p /run/sshd && \
    rm -f /etc/ssh/ssh_host_*

# Create workspace directory
RUN mkdir -p /workspace/runpod-slim
WORKDIR /workspace/runpod-slim

# Expose ports
EXPOSE 8188 22 8888 8080

# Copy start script
COPY start.5090.sh /start.sh
RUN chmod +x /start.sh

# Set Python 3.12 as default
RUN update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.12 1 && \
    update-alternatives --set python3 /usr/bin/python3.12

ENTRYPOINT ["/start.sh"]